<!DOCTYPE html>
<html lang="en" class="min-h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reminders - FreeFlow</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/print.css">
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Manifest for PWA -->
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#0f172a" />
</head>
<body class="bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 min-h-screen">
    <nav class="navbar">
        <div class="nav-brand">
            <h1>FreeFlow</h1>
        </div>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="clients.html" class="nav-link">Clients</a>
            <a href="invoices.html" class="nav-link">Invoices</a>
            <a href="projects.html" class="nav-link">Projects</a>
            <a href="reminders.html" class="nav-link active">Reminders</a>
            <button id="themeToggle" class="no-print rounded-xl px-3 py-2 bg-slate-800 text-white dark:bg-slate-100 dark:text-slate-900 mr-2">Toggle Theme</button>
            <button id="logoutBtn" class="btn btn-secondary">Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h2>Reminders</h2>
            <p>Keep track of overdue invoices and important deadlines</p>
        </div>
        
        <div class="mb-4 p-4 bg-blue-50 dark:bg-slate-800 rounded-xl">
            <h3 class="text-lg font-semibold mb-2">Test Notifications</h3>
            <div class="flex gap-2 flex-wrap">
                <input id="remTitle" placeholder="Custom reminder title" class="border-2 border-gray-200 p-2 rounded-xl flex-1 min-w-60 dark:bg-slate-700 dark:border-slate-600 dark:text-white" />
                <button id="remNotify" class="rounded-xl px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700">Send Notification</button>
                <button id="requestNotificationPerm" class="rounded-xl px-4 py-2 bg-blue-600 text-white hover:bg-blue-700">Enable Notifications</button>
            </div>
        </div>

        <div class="reminders-section">
            <div class="section">
                <h3>Overdue Invoices</h3>
                <div id="overdueInvoices" class="reminders-list">
                    <!-- Overdue invoices will be populated here -->
                </div>
            </div>

            <div class="section">
                <h3>Upcoming Due Dates (Next 7 Days)</h3>
                <div id="upcomingDueDates" class="reminders-list">
                    <!-- Upcoming due dates will be populated here -->
                </div>
            </div>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">âœ…</div>
            <h3>All caught up!</h3>
            <p>No overdue invoices or upcoming deadlines at the moment.</p>
        </div>
    </main>

    <script type="module">
        import "./js/app.js";
        import { storage } from "./js/modules/storage.js";
        import { toast, remind } from "./js/modules/notifications.js";
        
        function getCurrentUser() {
            return JSON.parse(localStorage.getItem('currentUser') || 'null');
        }
        
        function getUserData(key) {
            const currentUser = getCurrentUser();
            if (!currentUser) return [];
            const data = localStorage.getItem(`${currentUser.id}_${key}`);
            return data ? JSON.parse(data) : [];
        }
        
        function saveUserData(key, data) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            localStorage.setItem(`${currentUser.id}_${key}`, JSON.stringify(data));
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        function isOverdue(dateString) {
            const today = new Date();
            const dueDate = new Date(dateString);
            today.setHours(0, 0, 0, 0);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate < today;
        }
        
        function isUpcoming(dateString) {
            const today = new Date();
            const dueDate = new Date(dateString);
            const sevenDaysFromNow = new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000));
            
            today.setHours(0, 0, 0, 0);
            dueDate.setHours(0, 0, 0, 0);
            sevenDaysFromNow.setHours(0, 0, 0, 0);
            
            return dueDate >= today && dueDate <= sevenDaysFromNow;
        }
        
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, (m) => map[m]);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('currentUser')) {
                window.location.href = 'index.html';
                return;
            }
            
            setupLogout();
            loadReminders();
            setupNotificationHandlers();
        });
        
        function setupLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('currentUser');
                    toast('Logged out successfully', 'info');
                    setTimeout(() => window.location.href = 'index.html', 1000);
                });
            }
        }
        
        function setupNotificationHandlers() {
            const btn = document.getElementById('remNotify');
            const inp = document.getElementById('remTitle');
            const permBtn = document.getElementById('requestNotificationPerm');
            
            btn.addEventListener('click', async () => {
                const title = inp.value.trim() || 'FreeFlow Reminder';
                toast('Reminder scheduled', 'success');
                await remind(title, { body: "Don't forget!", badge: "/icon-192.png", icon: "/icon-192.png" });
            });
            
            permBtn.addEventListener('click', async () => {
                if (!('Notification' in window)) {
                    toast('Notifications not supported in this browser', 'error');
                    return;
                }
                
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    toast('Notifications enabled successfully!', 'success');
                } else {
                    toast('Notification permission denied', 'error');
                }
            });
        }
        
        function loadReminders() {
            const invoices = getUserData('invoices');
            const clients = getUserData('clients');
            
            const overdueInvoices = invoices.filter(invoice => 
                invoice.status === 'Pending' && isOverdue(invoice.dueDate)
            );
            
            const upcomingInvoices = invoices.filter(invoice => 
                invoice.status === 'Pending' && isUpcoming(invoice.dueDate)
            );
            
            displayOverdueInvoices(overdueInvoices, clients);
            displayUpcomingDueDates(upcomingInvoices, clients);
            
            const hasReminders = overdueInvoices.length > 0 || upcomingInvoices.length > 0;
            toggleEmptyState('remindersSection', 'emptyState', hasReminders);
            
            if (hasReminders) {
                document.querySelector('.reminders-section').style.display = 'grid';
            } else {
                document.querySelector('.reminders-section').style.display = 'none';
            }
        }
        
        function displayOverdueInvoices(overdueInvoices, clients) {
            const container = document.getElementById('overdueInvoices');
            
            if (overdueInvoices.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center;">No overdue invoices</p>';
                return;
            }
            
            container.innerHTML = overdueInvoices.map(invoice => {
                const client = clients.find(c => c.id === invoice.clientId);
                const clientName = client ? client.name : 'Unknown Client';
                const daysOverdue = Math.floor((new Date() - new Date(invoice.dueDate)) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="reminder-item">
                        <div class="reminder-header">
                            <h4>Invoice #${invoice.invoiceNumber}</h4>
                            <span class="reminder-amount">${formatCurrency(invoice.amount)}</span>
                        </div>
                        <div class="reminder-details">
                            <p><strong>Client:</strong> ${escapeHtml(clientName)}</p>
                            <p><strong>Project:</strong> ${escapeHtml(invoice.project)}</p>
                            <p><strong>Due Date:</strong> ${formatDate(invoice.dueDate)} (${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} overdue)</p>
                        </div>
                        <div class="reminder-actions">
                            <button class="btn btn-success" onclick="markAsPaid('${invoice.id}')" data-role="freelancer,admin,accountant">Mark as Paid</button>
                            <button class="btn btn-primary" onclick="sendReminder('${invoice.id}')">Send Reminder</button>
                            <button class="btn btn-secondary" onclick="editInvoiceFromReminders('${invoice.id}')" data-role="freelancer,admin">Edit Invoice</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function displayUpcomingDueDates(upcomingInvoices, clients) {
            const container = document.getElementById('upcomingDueDates');
            
            if (upcomingInvoices.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center;">No upcoming due dates</p>';
                return;
            }
            
            container.innerHTML = upcomingInvoices.map(invoice => {
                const client = clients.find(c => c.id === invoice.clientId);
                const clientName = client ? client.name : 'Unknown Client';
                const daysUntilDue = Math.ceil((new Date(invoice.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="reminder-item upcoming">
                        <div class="reminder-header">
                            <h4>Invoice #${invoice.invoiceNumber}</h4>
                            <span class="reminder-amount upcoming">${formatCurrency(invoice.amount)}</span>
                        </div>
                        <div class="reminder-details">
                            <p><strong>Client:</strong> ${escapeHtml(clientName)}</p>
                            <p><strong>Project:</strong> ${escapeHtml(invoice.project)}</p>
                            <p><strong>Due Date:</strong> ${formatDate(invoice.dueDate)} (${daysUntilDue} day${daysUntilDue !== 1 ? 's' : ''} remaining)</p>
                        </div>
                        <div class="reminder-actions">
                            <button class="btn btn-success" onclick="markAsPaid('${invoice.id}')" data-role="freelancer,admin,accountant">Mark as Paid</button>
                            <button class="btn btn-primary" onclick="sendReminder('${invoice.id}')">Send Reminder</button>
                            <button class="btn btn-secondary" onclick="editInvoiceFromReminders('${invoice.id}')" data-role="freelancer,admin">Edit Invoice</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleEmptyState(containerId, emptyStateId, hasData) {
            const container = document.getElementById(containerId);
            const emptyState = document.getElementById(emptyStateId);
            
            if (container) {
                container.style.display = hasData ? 'block' : 'none';
            }
            
            if (emptyState) {
                emptyState.style.display = hasData ? 'none' : 'block';
            }
        }
        
        window.markAsPaid = function(invoiceId) {
            if (!confirm('Mark this invoice as paid?')) {
                return;
            }
            
            const invoices = getUserData('invoices');
            const invoiceIndex = invoices.findIndex(i => i.id === invoiceId);
            
            if (invoiceIndex !== -1) {
                invoices[invoiceIndex].status = 'Paid';
                invoices[invoiceIndex].paidAt = new Date().toISOString();
                invoices[invoiceIndex].updatedAt = new Date().toISOString();
                
                saveUserData('invoices', invoices);
                loadReminders();
                toast('Invoice marked as paid', 'success');
            }
        }
        
        window.sendReminder = function(invoiceId) {
            const invoices = getUserData('invoices');
            const invoice = invoices.find(i => i.id === invoiceId);
            
            if (invoice) {
                const clients = getUserData('clients');
                const client = clients.find(c => c.id === invoice.clientId);
                const clientName = client ? client.name : 'Unknown Client';
                
                toast(`Reminder sent to ${clientName}`, 'success');
                remind(`Payment Reminder: Invoice #${invoice.invoiceNumber}`, {
                    body: `Payment due for ${clientName} - ${formatCurrency(invoice.amount)}`,
                    badge: "/icon-192.png",
                    icon: "/icon-192.png"
                });
                
                const invoiceIndex = invoices.findIndex(i => i.id === invoiceId);
                if (invoiceIndex !== -1) {
                    invoices[invoiceIndex].lastReminderSent = new Date().toISOString();
                    invoices[invoiceIndex].updatedAt = new Date().toISOString();
                    saveUserData('invoices', invoices);
                }
            }
        }
        
        window.editInvoiceFromReminders = function(invoiceId) {
            localStorage.setItem('editInvoiceId', invoiceId);
            window.location.href = 'invoices.html';
        }
    </script>
</body>
</html>
