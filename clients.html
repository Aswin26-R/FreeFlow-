<!DOCTYPE html>
<html lang="en" class="min-h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clients - FreeFlow</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/print.css">
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Manifest for PWA -->
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#0f172a" />
</head>
<body class="bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 min-h-screen">
    <nav class="navbar">
        <div class="nav-brand">
            <h1>FreeFlow</h1>
        </div>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="clients.html" class="nav-link active">Clients</a>
            <a href="invoices.html" class="nav-link">Invoices</a>
            <a href="projects.html" class="nav-link">Projects</a>
            <a href="reminders.html" class="nav-link">Reminders</a>
            <button id="themeToggle" class="no-print rounded-xl px-3 py-2 bg-slate-800 text-white dark:bg-slate-100 dark:text-slate-900 mr-2">Toggle Theme</button>
            <button id="logoutBtn" class="btn btn-secondary">Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h2>Clients</h2>
            <div class="flex gap-2">
                <button id="addClientBtn" class="btn btn-primary" data-role="freelancer,admin">Add Client</button>
                <button id="exportClientsBtn" class="btn btn-secondary no-print" data-role="freelancer,admin,accountant">Export CSV</button>
            </div>
        </div>
        
        <div class="mb-4">
            <input id="searchClients" placeholder="Search clients by name or email" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none dark:bg-slate-800 dark:border-slate-600 dark:text-white" />
        </div>

        <!-- Add Client Modal -->
        <div id="clientModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Add Client</h3>
                    <span class="close">&times;</span>
                </div>
                <form id="clientForm">
                    <div class="form-group">
                        <label for="clientName">Name</label>
                        <input type="text" id="clientName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="clientEmail">Email</label>
                        <input type="email" id="clientEmail" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="clientPhone">Phone</label>
                        <input type="tel" id="clientPhone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="clientNotes">Notes</label>
                        <textarea id="clientNotes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Client</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-container">
            <table id="clientsTable" class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody">
                    <!-- Clients will be populated here -->
                </tbody>
            </table>
            <div id="emptyState" class="empty-state" style="display: none;">
                <p>No clients found. Add your first client to get started!</p>
            </div>
        </div>
    </main>

    <script type="module">
        import "./js/app.js";
        import { storage } from "./js/modules/storage.js";
        import { toast } from "./js/modules/notifications.js";
        import { isEmail, requireFields } from "./js/modules/validation.js";
        import { tableToCSV } from "./js/modules/export.js";
        
        let editingClientId = null;
        
        function getCurrentUser() {
            return JSON.parse(localStorage.getItem('currentUser') || 'null');
        }
        
        function getUserData(key) {
            const currentUser = getCurrentUser();
            if (!currentUser) return [];
            const data = localStorage.getItem(`${currentUser.id}_${key}`);
            return data ? JSON.parse(data) : [];
        }
        
        function saveUserData(key, data) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            localStorage.setItem(`${currentUser.id}_${key}`, JSON.stringify(data));
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, (m) => map[m]);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('currentUser')) {
                window.location.href = 'index.html';
                return;
            }
            
            setupLogout();
            loadClients();
            setupEventListeners();
            setupSearch();
        });
        
        function setupLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('currentUser');
                    toast('Logged out successfully', 'info');
                    setTimeout(() => window.location.href = 'index.html', 1000);
                });
            }
        }
        
        function setupEventListeners() {
            document.getElementById('addClientBtn').addEventListener('click', () => {
                editingClientId = null;
                document.getElementById('modalTitle').textContent = 'Add Client';
                document.getElementById('clientForm').reset();
                openModal('clientModal');
            });
            
            document.getElementById('clientForm').addEventListener('submit', handleClientSubmit);
            document.getElementById('exportClientsBtn').addEventListener('click', () => {
                tableToCSV('#clientsTable', 'clients.csv');
                toast('Clients exported to CSV', 'success');
            });
            
            setupModalHandlers('clientModal', 'clientForm');
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('searchClients');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const clients = getUserData('clients');
                const filteredClients = clients.filter(client => 
                    client.name.toLowerCase().includes(query) || 
                    client.email.toLowerCase().includes(query)
                );
                renderClientsTable(filteredClients);
            });
        }
        
        function loadClients() {
            const clients = getUserData('clients');
            renderClientsTable(clients);
        }
        
        function renderClientsTable(clients) {
            const tableBody = document.getElementById('clientsTableBody');
            
            if (clients.length === 0) {
                toggleEmptyState('clientsTable', 'emptyState', false);
                return;
            }
            
            toggleEmptyState('clientsTable', 'emptyState', true);
            
            tableBody.innerHTML = clients.map(client => `
                <tr>
                    <td>${escapeHtml(client.name)}</td>
                    <td>${escapeHtml(client.email)}</td>
                    <td>${escapeHtml(client.phone || '')}</td>
                    <td>${escapeHtml(client.notes || '')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="editClient('${client.id}')" data-role="freelancer,admin">Edit</button>
                            <button class="btn btn-danger" onclick="deleteClient('${client.id}')" data-role="freelancer,admin">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function toggleEmptyState(containerId, emptyStateId, hasData) {
            const container = document.getElementById(containerId);
            const emptyState = document.getElementById(emptyStateId);
            
            if (container) {
                container.style.display = hasData ? 'block' : 'none';
            }
            
            if (emptyState) {
                emptyState.style.display = hasData ? 'none' : 'block';
            }
        }
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function setupModalHandlers(modalId, formId) {
            const modal = document.getElementById(modalId);
            const closeBtn = modal.querySelector('.close');
            const cancelBtn = modal.querySelector('#cancelBtn');
            const form = document.getElementById(formId);
            
            closeBtn.addEventListener('click', () => closeModal(modalId));
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    closeModal(modalId);
                    if (form) form.reset();
                });
            }
            
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modalId);
                    if (form) form.reset();
                }
            });
        }
        
        function handleClientSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const clientData = {
                name: formData.get('name').trim(),
                email: formData.get('email').trim(),
                phone: formData.get('phone').trim(),
                notes: formData.get('notes').trim()
            };
            
            if (!requireFields(form, ['name', 'email'])) {
                toast('Name and email are required', 'error');
                return;
            }
            
            if (!isEmail(clientData.email)) {
                toast('Please enter a valid email address', 'error');
                return;
            }
            
            const clients = getUserData('clients');
            
            const existingClient = clients.find(c => 
                c.email === clientData.email && c.id !== editingClientId
            );
            
            if (existingClient) {
                toast('A client with this email already exists', 'error');
                return;
            }
            
            if (editingClientId) {
                const clientIndex = clients.findIndex(c => c.id === editingClientId);
                if (clientIndex !== -1) {
                    clients[clientIndex] = {
                        ...clients[clientIndex],
                        ...clientData,
                        updatedAt: new Date().toISOString()
                    };
                }
                toast('Client updated successfully', 'success');
            } else {
                const newClient = {
                    id: generateId(),
                    ...clientData,
                    createdAt: new Date().toISOString()
                };
                clients.push(newClient);
                toast('Client added successfully', 'success');
            }
            
            saveUserData('clients', clients);
            loadClients();
            closeModal('clientModal');
            form.reset();
            editingClientId = null;
        }
        
        window.editClient = function(clientId) {
            const clients = getUserData('clients');
            const client = clients.find(c => c.id === clientId);
            
            if (!client) return;
            
            editingClientId = clientId;
            document.getElementById('modalTitle').textContent = 'Edit Client';
            
            document.getElementById('clientName').value = client.name;
            document.getElementById('clientEmail').value = client.email;
            document.getElementById('clientPhone').value = client.phone || '';
            document.getElementById('clientNotes').value = client.notes || '';
            
            openModal('clientModal');
        }
        
        window.deleteClient = function(clientId) {
            if (!confirm('Are you sure you want to delete this client? This action cannot be undone.')) {
                return;
            }
            
            const clients = getUserData('clients');
            const updatedClients = clients.filter(c => c.id !== clientId);
            
            saveUserData('clients', updatedClients);
            
            const invoices = getUserData('invoices');
            const updatedInvoices = invoices.filter(i => i.clientId !== clientId);
            saveUserData('invoices', updatedInvoices);
            
            const tasks = getUserData('tasks');
            const updatedTasks = tasks.map(task => {
                if (task.clientId === clientId) {
                    const { clientId, ...taskWithoutClient } = task;
                    return taskWithoutClient;
                }
                return task;
            });
            saveUserData('tasks', updatedTasks);
            
            loadClients();
            toast('Client deleted successfully', 'success');
        }
    </script>
</body>
</html>
